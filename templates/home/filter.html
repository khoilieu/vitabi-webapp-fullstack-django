{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
    <link rel="icon" href="{% static "home/favicon.png" %}" type="image/x-icon">
    <title>Filter</title>
    <link rel="stylesheet" href="{% static "home/filter.css" %}">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://getbootstrap.com/docs/5.3/assets/css/docs.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Tag Manager -->
		<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
			new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
			j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
			'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
			})(window,document,'script','dataLayer','GTM-NBX832CK');</script>
    <!-- End Google Tag Manager -->

    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "nqixhxf3g6");
    </script>
    <style>
        .firstpreferredtime {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        main {
            padding-right: 10%;
            padding-left: 10%;
            padding-top: 10%;
            padding-bottom: 30%;
            height: calc(100vh - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-width: none;
            text-align: center;
        }
    </style>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const customDistanceCheckbox = document.getElementById('custom-distance-checkbox');
            const customDistanceInput = document.getElementById('custom-distance-input');
            const customDistanceNumber = document.querySelector('#custom-distance-input input');
            const customHoursCheckbox = document.getElementById('custom-hours-checkbox');
            const customHoursInput = document.getElementById('custom-hours-input');
            const customDateInput = document.getElementById('custom-date-input'); 
        
            function toggleInputVisibility() {
                if (customDistanceCheckbox.checked) {
                    customDistanceInput.style.display = 'block';
                } else {
                    customDistanceInput.style.display = 'none';
                    customDistanceNumber.value = '';
                }
            }
        
            function toggleHoursInputVisibility() {
                if (customHoursCheckbox.checked) {
                    customHoursInput.style.display = 'block';
                    customDateInput.style.display = 'block';
                } else {
                    customHoursInput.style.display = 'none';
                    document.getElementById('time_from').value = '';
                    document.getElementById('time_to').value = '';
                    customDateInput.style.display = 'none';
                    document.getElementById('date_filter').value = '';
                }
            }
        
            toggleInputVisibility();
            toggleHoursInputVisibility();
        
            customDistanceCheckbox.addEventListener('change', toggleInputVisibility);
            customHoursCheckbox.addEventListener('change', toggleHoursInputVisibility);
        });        
        
        function manageSingleSelection(className) {
            const checkboxes = document.querySelectorAll('.' + className);
            checkboxes.forEach(function(checkbox) {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        checkboxes.forEach(function(other) {
                            if (other !== checkbox) other.checked = false;
                        });
                    }
                });
            });
        }        
    </script>
</head>
  <body>
    <section>
        <header>
            <div style="width: 45px; height: 45px; display: flex; justify-content: flex-start; align-items: center;">
                <a href="{% url 'findHospital' %}?{{ filter_query_string }}">
                    <img src="{% static "home/arrow-left.svg" %}" alt="Back-arrow" style="width: 22px; height: 22px;">
                </a>                              
            </div>
          <div class="top">
                <h1 class="h1">{% trans "Filter" %}</h1>      
            </div>
            <div style="width: 60px; height: 45px; display: flex; justify-content: center; align-items: center;">
                <a href="#" style="text-decoration: none; color: #000;" onclick="resetAndRedirect()"><strong>{% trans "Reset" %}</strong></a>
            </div>
        </header>

        <main>
            <div class="card-body">
                <form id="searchForm" action="{% url 'findHospital' %}" method="get">

                <h3 style="margin-top: 0px !important;">{% trans "Country" %}</h3>
                <select id="country" name="country" class="form-control">
                    <option value="">{% trans 'Select Country' %}</option>
                    {% for code, name, count in countries %}
                        <option value="{{ code }}" {% if saved_data.country == code %}selected{% endif %}>{{ name }} ({{ count }})</option>
                    {% endfor %}
                </select>

                <h3>{% trans "Insurance" %}</h3>
                <select class="form-select" name="insurance">
                    <option value="">{% trans 'All Insurances' %}</option>
                    {% for insurance, translated_name in insurances %}
                    <option value="{{ insurance.name }}" {% if saved_data.insurance == insurance.name %}selected{% endif %}>
                        {{ translated_name }}
                    </option>
                    {% endfor %}
                </select>

                {% comment %} <label>
                    <input type="checkbox" name="affiliated_with_insurers">
                    {% trans "Affiliated with insurers" %}
                </label><br> {% endcomment %}
    
                <h3>{% trans "Language" %}</h3>
                <label>
                    <input type="checkbox" class="language-option" name="japanese_speaking_staff" {% if saved_data.japanese_speaking_staff %}checked{% endif %}>
                    {% trans "Japanese-speaking staff available" %}
                </label><br>
                <label>
                    <input type="checkbox" class="language-option" name="english_speaking_staff" {% if saved_data.english_speaking_staff %}checked{% endif %}>
                    {% trans "English-speaking staff available" %}
                </label>

                <h3>{% trans "Opening Hours" %}</h3>
                <label>
                    <input type="checkbox" class="hours-option" name="current_time_filter" value="true" {% if saved_data.current_time_filter %}checked{% endif %}>
                    {% trans "Open Now" %}
                </label><br>
    
                <label>
                    <input type="checkbox" class="hours-option" name="allday" value="allday" {% if saved_data.allday %}checked{% endif %}>
                    {% trans "All Day" %}
                </label><br>

                <label>
                    <input type="checkbox" class="hours-option" id="custom-hours-checkbox" {% if saved_data.time_from %}checked{% endif %}>
                    {% trans "Custom Hours" %}
                </label>
                <label id="custom-date-input">
                    <input type="date" name="date_filter" id="date_filter" value="{{ saved_data.date_filter }}" class="form-control mt-3" required>
                </label>               
                <label id="custom-hours-input">
                    <div class="firstpreferredtime mt-3">
                        <input type="time" name="time_from" id="time_from" value="{{ saved_data.time_from }}" class="form-control" required>
                        <p style="margin: 0">~</p>
                        <input type="time" name="time_to" id="time_to" value="{{ saved_data.time_to }}" class="form-control" required>
                    </div>
                </label>
    
                <h3>{% trans "Distance" %}</h3>
                <label>
                    <input type="checkbox" class="distance-option" name="distance" value="1" {% if '1' in saved_data.distance %}checked{% endif %}>
                    {% trans "Less than 1km" %} ({{ distance_counts.1|default:"0" }})
                </label><br>

                <label>
                    <input type="checkbox" class="distance-option" name="distance" value="3" {% if '3' in saved_data.distance %}checked{% endif %}>
                    {% trans "Less than 3km" %} ({{ distance_counts.3|default:"0" }})
                </label><br>

                <label>
                    <input type="checkbox" class="distance-option" name="distance" value="5" {% if '5' in saved_data.distance %}checked{% endif %}>
                    {% trans "Less than 5km" %} ({{ distance_counts.5|default:"0" }})
                </label>
                <br>
                <label>
                    <input type="checkbox" class="distance-option" id="custom-distance-checkbox" {% if saved_data.custom_distance %}checked{% endif %}>
                    {% trans "Custom Distance" %}
                </label>
                <label id="custom-distance-input">
                    <input type="number" name="custom_distance" placeholder="{% trans 'Enter distance in km' %}" class="form-control mb-3 mt-3" value="{{ saved_data.custom_distance|default_if_none:'' }}">
                </label>
                
                </form>
              </div>
        </main>

        <div class="footer">
          <button class="proceed-button" style="width: 100%;" id="searchButton">{% trans "Search" %}</button>
        </div>
    </section>

  </body>
  {% if user.is_authenticated and user.patient.is_patient %}
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NBX832CK"
      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
      <!-- End Google Tag Manager (noscript) -->	
  {% endif %}		
</html>

<script>
    document.getElementById('searchButton').addEventListener('click', function() {
      document.getElementById('searchForm').submit();
    });

    let currentIndex = 0; 
    const slides = document.querySelectorAll(".slide"); 
    const totalSlides = slides.length;

    function moveSlide(direction) {
        currentIndex += direction; 
        if (currentIndex >= totalSlides) { 
        currentIndex = 0;
        } else if (currentIndex < 0) { 
        currentIndex = totalSlides - 1;
        }
        updateSlidePosition();
    }

    function updateSlidePosition() {
        for (let i = 0; i < slides.length; i++) {
        slides[i].style.transform = `translateX(-${currentIndex * 100}%)`; 
        slides[i].style.transition = 'transform 0.5s ease-out'; 
        }
    }

    function enlargeImage(img) {
        let modal = document.getElementById("myModal");
        let modalImg = document.getElementById("img01");
        let captionText = document.getElementById("caption");
        modal.style.display = "block";
        modalImg.src = img.src;
        captionText.innerHTML = img.alt;

        let span = document.getElementsByClassName("close")[0];

        span.onclick = function () {
        modal.style.display = "none";
        };
    }

    var map = L.map("map").setView([0, 0], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors",
    }).addTo(map);

    fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
        "{{ hospital.address }}"
        )}`
    )
        .then((response) => response.json())
        .then((data) => {
        if (data.length > 0) {
            var lat = data[0].lat;
            var lon = data[0].lon;
            map.setView([lat, lon], 15); 
            L.marker([lat, lon]).addTo(map);
        } else {
            console.log("No results found");
        }
        })
        .catch((error) => console.log("Error:", error));

    function resetAndRedirect() {
        if (confirm('Are you sure you want to reset all filters?')) {
            document.getElementById('searchForm').reset(); 
            window.location.href = "{% url 'reset_filter' %}";
        }
    }
</script>
  
