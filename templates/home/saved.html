{% load static %}
{% load i18n %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
    <link rel="icon" href="{% static "home/favicon.png" %}" type="image/x-icon">
    <title>Saved</title>
    <link rel="stylesheet" href="{% static "home/saved.css" %}">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://getbootstrap.com/docs/5.3/assets/css/docs.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Tag Manager -->
		<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
			new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
			j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
			'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
			})(window,document,'script','dataLayer','GTM-NBX832CK');</script>
		<!-- End Google Tag Manager -->

    <script type="text/javascript">
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "nqixhxf3g6");
  </script>
</head>
<style>
  .no-info {
    color: #999;
    font-size: 18px;
    text-align: center;
  }

  .hospital-item {
    margin-top: 10px;
    display: flex;
    width: 337px;
    border: 1px solid #ccc;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    margin-bottom: 10px;
    position: relative;
    cursor: pointer;
    height: 200px;
  }

  .hospita-direct {
    position: absolute;
    bottom: 0px;
    right: 20px;
    color: #fff;
    padding: 5px 10px;
    font-weight: bold;
  }
</style>
  <body>
    <section>
        <header>
            <a href="{% url "mydata" %}"><img src="{% static "home/arrow-left.svg" %}" alt="Back-arrow" style="width: 22px; height: 22px;"></a>
            <div class="top">
                <h1 class="h1">{% trans "Hospital Saved" %}</h1>      
            </div>
            <div style="width: 22px; height: 22px;"></div>
        </header>


        <main>
          <div class="body">
            {% if saved %}
            {% for save in saved %}
            <div class="hospital-list-container" id="hospital-list">
              <div class="hospital-item favourite" data-url="{% url "hospitalInfo" save.hospital.id %}" data-latitude="{{ save.hospital.latitude }}" data-longitude="{{ save.hospital.longitude }}" data-favourite="true">
                {% with save.hospital.images.first as image %}
                  <img class="hospital-photo" src="{{ image.photo.url }}" alt="Image for {{ hospital.name }}" />
                {% endwith %}
                <div class="hospital-info">
                    <div class="hospital-rating">{{ save.hospital.rating }}</div>
                    <div class="hospital-english">{% trans "ENGLISH AVAILABLE" %}</div>



                    <h2>{{ save.hospital.name }}</h2>
                    <p style="font-weight: 700; font-size: 12px;">{{ save.hospital.country.name }} | 
                      {% if open_status|get_value:save.hospital.id %} 
                        <span class="text-success">{% trans "Open" %}</span>
                      {% else %}
                        <span class="text-danger">{% trans "Closed" %}</span>
                      {% endif %}
                    </p>
                    <p class="distance">{% trans "Calculating..." %}</p>
                    <p>{% trans "Open" %}: 
                      <select style="padding: 3px; border-radius: 6px;" id="working_hours_{{ save.hospital.id }}">
                          {% for hours in hospital_working_hours|get_item:save.hospital.id %}
                              <option>{{ hours }}</option>
                          {% endfor %}
                      </select>
                    </p>


                    <div class="hospita-direct">
                      {% if save.hospital.direct_billing == True %}
                        <h3>{% trans "Direct Billing Available" %}</h3>
                      {% endif %}
                    </div>
                    
                </div>
              </div>
            </div>
            {% endfor %}
            {% else %}
            <p class="no-info">{% trans "No saved hospitals found" %}.</p>
            {% endif %}
          </div>   
        </main>

        <div class="footer">
          <a href="{% url "home" %}" class="nav-link" style="width: 70px;">
            <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            fill="currentColor"
            class="bi bi-house"
            viewBox="0 0 16 16"
            >
            <path
            d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L2 8.207V13.5A1.5 1.5 0 0 0 3.5 15h9a1.5 1.5 0 0 0 1.5-1.5V8.207l.646.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293zM13 7.207V13.5a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5V7.207l5-5z"
            />
            </svg>
            <span>{% trans "Home" %}</span>
          </a>
          <a href="{% url "care" %}" class="nav-link" style="width: 70px;">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              fill="currentColor"
              class="bi bi-calendar-event"
              viewBox="0 0 16 16"
            >
              <path
              d="M11 6.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5z"
              />
              <path
              d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5M1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4z"
              />
            </svg>
            <span>{% trans "Bookings" %}</span>
          </a>
          <a href="{% url "mydata" %}" class="nav-link" style="width: 70px;">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              fill="currentColor"
              class="bi bi-card-list"
              viewBox="0 0 16 16"
            >
              <path
              d="M14.5 3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5zm-13-1A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2z"
              />
              <path
              d="M5 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 5 8m0-2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m0 5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m-1-5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0M4 8a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0m0 2.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0"
              />
            </svg>
            <span>{% trans "My Data" %}</span>
          </a>
        </div>
    </section>
  </body>
  {% if user.is_authenticated and user.patient.is_patient %}
	<!-- Google Tag Manager (noscript) -->
	<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NBX832CK"
		height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
		<!-- End Google Tag Manager (noscript) -->	
	{% endif %}
</html>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const hospitalListItems = document.querySelectorAll(".hospital-item");

    hospitalListItems.forEach(function (item) {
      item.addEventListener("click", function (event) {
        if (event.target.tagName.toLowerCase() !== 'select') {
          window.location.href = this.getAttribute("data-url");
        }
      });
    });

    hospitalListItems.forEach(function (item) {
      item.addEventListener("mouseover", function () {
        this.style.transform = "scale(0.95)";
      });

      item.addEventListener("mouseout", function () {
        this.style.transform = "scale(1)";
      });
    });

    sendUserLocation();

  });

  function sendUserLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const userLocation = `${position.coords.latitude},${position.coords.longitude}`;

            const hospitalItems = document.querySelectorAll('.hospital-item');
            hospitalItems.forEach(item => {
                const lat = item.getAttribute('data-latitude');
                const lon = item.getAttribute('data-longitude');

                if (lat && lon) {
                    const distance = calculateDistance(position.coords.latitude, position.coords.longitude, lat, lon);
                    item.setAttribute('data-distance-value', distance);
                    item.querySelector('.distance').textContent = `{% trans "Distance" %}: ${distance.toFixed(2)} km`;
                } else {
                    item.querySelector('.distance').textContent = '{% trans "Distance information not available" %}';
                }
            });
        });
    } else {
        console.log("Geolocation is not supported by this browser.");
    }
  }

  function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; 
    const dLat = deg2rad(lat2 - lat1);
    const dLon = deg2rad(lon2 - lon1);
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
      Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    const distance = R * c;
    return distance;
  }

  function deg2rad(deg) {
    return deg * (Math.PI / 180);
  }

  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }
</script>
